# Flux API Summary

Condensed reference for the Flux CRDs.
For Flux Operator CRDs (FluxInstance, FluxReport, ResourceSet, ResourceSetInputProvider), see `@references/flux-operator-api-summary.md`.

## Source API

### GitRepository (`source.toolkit.fluxcd.io/v1`)

Produces an Artifact from a Git repository revision.

**Key fields:**
- `.spec.url` — Git repository URL (HTTPS or SSH)
- `.spec.ref.branch` / `.spec.ref.tag` / `.spec.ref.name` / `.spec.ref.semver` / `.spec.ref.commit` — Git reference to checkout
- `.spec.ref.name` is for exact refs like `refs/heads/main` — used by FluxInstance sync
- `.spec.interval` — Polling interval (e.g., `5m`, `1h`)
- `.spec.secretRef` — Secret with auth credentials (SSH identity/known_hosts, username/PAT, GitHub App private key)
- `.spec.sparseCheckout` — List of directories to checkout (only these will be in the artifact)

**Pattern:** Mainly used for fetching Kubernetes manifests referenced by Flux Kustomizations.
**Gotcha:** Use `.spec.sparseCheckout` to fetch only the directories needed, reducing clone size and artifact scope.

### OCIRepository (`source.toolkit.fluxcd.io/v1`)

Produces an Artifact from an OCI container registry.

**Key fields:**
- `.spec.url` — OCI URL with `oci://` prefix
- `.spec.ref.tag` / `.spec.ref.semver` / `.spec.ref.digest` — Artifact reference
- `.spec.interval` — Polling interval
- `.spec.layerSelector.mediaType` — Media type filter (use `application/vnd.cncf.helm.chart.content.v1.tar+gzip` for Helm charts)
- `.spec.layerSelector.operation` — `extract` (default) or `copy`
- `.spec.verify.provider` — `cosign` for signature verification
- `.spec.provider` — Auth provider: `generic` `aws`, `gcp`, `azure`
- `.spec.secretRef` — Image pull secret reference (if not using Workload Identity)

**Pattern:** Preferred over HelmRepository for OCI registries. Use with `.spec.chartRef` on HelmRelease. When pointing to AWS (ECR), GCP (Artifact Registry/GCR), or Azure (ACR) registries, set `.spec.provider` to use Workload Identity instead of static credentials.
**Gotcha:** For Helm charts stored as OCI artifacts, set `layerSelector.operation: copy`.

### Bucket (`source.toolkit.fluxcd.io/v1`)

Produces an Artifact from an S3-compatible bucket.

**Key fields:**
- `.spec.provider` — `generic`, `aws`, `gcp`, `azure`
- `.spec.endpoint` — Bucket endpoint URL
- `.spec.bucketName` — Name of the bucket
- `.spec.prefix` — Object key prefix to filter
- `.spec.secretRef` — Auth credentials secret

### HelmRepository (`source.toolkit.fluxcd.io/v1`)

References a Helm chart repository (HTTP/S or OCI).

**Key fields:**
- `.spec.url` — Repository URL (HTTPS for HTTP repos, `oci://` for OCI registries)
- `.spec.type` — `default` (HTTP) or `oci`
- `.spec.interval` — Polling interval
- `.spec.secretRef` — Auth credentials

**Pattern:** Use for traditional HTTPS Helm chart repositories only.
**Gotcha:** `HelmRepository` with `type: oci` is a legacy pattern. Recommend migrating to `OCIRepository` with `chartRef` on HelmRelease — OCIRepository supports Cosign signature verification, semver-based tag policies, and layer selection that HelmRepository OCI mode does not.

### HelmChart (`source.toolkit.fluxcd.io/v1`)

References a chart from a HelmRepository or GitRepository. Usually auto-created by HelmRelease.

**Key fields:**
- `.spec.chart` — Chart name
- `.spec.version` — Semver range
- `.spec.sourceRef` — Reference to HelmRepository or GitRepository
- `.spec.reconcileStrategy` — `ChartVersion` (default) or `Revision` (needed for Git)

**Pattern:** Typically not created manually — HelmRelease creates HelmCharts automatically from `.spec.chart.spec`.

### ExternalArtifact (`source.toolkit.fluxcd.io/v1`)

Represents a 3rd-party source controller artifact. Managed by ArtifactGenerator, not created manually.

**Key fields:**
- `.spec.sourceRef` — Optional reference to the originating source

**Pattern:** Generated by ArtifactGenerator for monorepo decomposition or source composition.

### ArtifactGenerator (`source.extensions.fluxcd.io/v1beta1`)

Composes and decomposes sources into new ExternalArtifacts.

**Key fields:**
- `.spec.sources[]` — Source references with aliases (`alias`, `kind`, `name`)
- `.spec.artifacts[]` — Output artifact definitions with copy rules
  - `.copy[].from` — Source path using `@alias/path/**` syntax
  - `.copy[].to` — Destination path using `@artifact/path/` syntax

**Pattern:** Monorepo decomposition — split one GitRepository into multiple ExternalArtifacts for independent reconciliation. E.g., separate `infrastructure/**` and `apps/**` into independent artifacts so infra changes don't trigger app reconciliation.
**Gotcha:** Uses `@alias` and `@artifact` path prefixes. The `@monorepo` alias references the first source.

## Appliers API

### Kustomization (`kustomize.toolkit.fluxcd.io/v1`)

Builds and applies Kubernetes manifests from sources using Kustomize.

**Key fields:**
- `.spec.sourceRef` — Reference to source (GitRepository, OCIRepository, Bucket, ExternalArtifact)
- `.spec.path` — Path within the source to the kustomize directory
- `.spec.interval` — Reconciliation interval (also triggers drift detection via server-side apply dry-run)
- `.spec.retryInterval` — Retry interval on failure
- `.spec.timeout` — Timeout for the apply operation
- `.spec.prune` — Delete resources removed from source (set `true` for garbage collection)
- `.spec.wait` — Wait for all resources to become ready
- `.spec.dependsOn[]` — Other Kustomizations that must be ready first
- `.spec.targetNamespace` — Override namespace for all resources
- `.spec.patches[]` — Inline patches applied during build
- `.spec.postBuild.substitute` / `.spec.postBuild.substituteFrom` — Variable substitution after kustomize build
- `.spec.decryption` — SOPS decryption config (provider, secretRef)
- `.spec.serviceAccountName` — Service account for impersonation (multi-tenancy)
- `.spec.force` — Force apply (recreate immutable fields)

**Pattern:** Dependency chains for ordering: `infra-controllers` → `infra-configs` → `apps`. Use `wait: true` on dependencies.
**Gotcha:** Set `prune: true` on all Kustomizations for proper garbage collection. `force: true` causes downtime — use only for immutable field changes.

### HelmRelease (`helm.toolkit.fluxcd.io/v2`)

Manages Helm chart releases with install, upgrade, test, rollback, and drift detection.

**Key fields:**
- `.spec.chart.spec` — Inline chart template (chart, version, sourceRef, interval) — creates a HelmChart automatically
- `.spec.chartRef` — Direct reference to OCIRepository or HelmChart (preferred for OCI)
- `.spec.releaseName` — Helm release name
- `.spec.interval` — Reconciliation interval
- `.spec.timeout` — Timeout for Helm actions
- `.spec.values` / `.spec.valuesFrom` — Helm values (inline or from ConfigMap/Secret)
- `.spec.dependsOn[]` — Other HelmReleases that must be ready first
- `.spec.install.remediation.retries` — Retry count on install failure
- `.spec.install.crds` — CRD install policy: `Create`, `CreateReplace`, `Skip`
- `.spec.upgrade.remediation.retries` — Retry count on upgrade failure
- `.spec.upgrade.crds` — CRD upgrade policy: `CreateReplace`, `Skip`
- `.spec.driftDetection.mode` — `enabled`, `warn`, or `disabled`
- `.spec.driftDetection.ignore[]` — Paths to ignore during drift detection
- `.spec.test.enable` — Run Helm tests after install/upgrade
- `.spec.serviceAccountName` — Service account for impersonation (multi-tenancy)
- `.spec.postRenderers[]` — Post-rendering with Kustomize patches

**Pattern:** Use `.spec.chartRef` with OCIRepository for OCI charts. Enable `driftDetection.mode: enabled` in production.
**Gotcha:** `install.remediation.retries` and `upgrade.remediation.retries` is the legacy pattern. The new pattern uses `install.strategy` and `upgrade.strategy` with `RetryOnFailure` or `RemediateOnFailure`.

## Notification API

### Provider (`notification.toolkit.fluxcd.io/v1beta3`)

Configures notification services for forwarding events.

**Key fields:**
- `.spec.type` — Service type: `slack`, `msteams`, `discord`, `github`, `gitlab`, `bitbucketserver`, `googlechat`, `webex`, `generic`, `generic-hmac`, `opsgenie`, `pagerduty`, `datadog`, `grafana`, `matrix`, `ntfy`, `nats`, `sentry`, `azuredevops`, `azureeventhub`, `googlepubsub`
- `.spec.address` — Webhook URL or service address
- `.spec.channel` — Channel name (for Slack, Discord, etc.)
- `.spec.secretRef` — Secret with auth token

### Alert (`notification.toolkit.fluxcd.io/v1beta3`)

Configures events to be forwarded to a Provider.

**Key fields:**
- `.spec.providerRef` — Reference to Provider
- `.spec.eventSeverity` — Minimum severity: `info` or `error`
- `.spec.eventSources[]` — Source filter (kind, name, namespace, matchLabels)
- `.spec.eventMetadata` — Additional metadata for notifications
- `.spec.exclusionList[]` — Regex patterns to exclude events

**Pattern:** Use `eventSeverity: error` for production alerts, `info` for staging to get all notifications.

### Receiver (`notification.toolkit.fluxcd.io/v1`)

Defines webhooks for triggering immediate reconciliation.

**Key fields:**
- `.spec.type` — Webhook type: `github`, `gitlab`, `bitbucket`, `harbor`, `quay`, `acr`, `gcr`, `dockerhub`, `generic`, `generic-hmac`, `cdevents`
- `.spec.events[]` — Event types to handle (e.g., `push`, `ping`)
- `.spec.secretRef` — Webhook secret for verification
- `.spec.resources[]` — Resources to trigger reconciliation on (kind, name, namespace)

**Pattern:** Configure GitHub webhook → Receiver → triggers immediate GitRepository reconciliation on push (instead of waiting for polling interval).

## Image Automation API

### ImageRepository (`image.toolkit.fluxcd.io/v1`)

Scans container registries for new image tags.

**Key fields:**
- `.spec.image` — Container image to scan (without tag)
- `.spec.interval` — Scan interval
- `.spec.provider` — Auth provider: `generic`, `aws`, `gcp`, `azure`
- `.spec.secretRef` — Registry auth secret
- `.spec.exclusionList[]` — Regex patterns to exclude tags

### ImagePolicy (`image.toolkit.fluxcd.io/v1`)

Selects the latest image tag based on a policy.

**Key fields:**
- `.spec.imageRepositoryRef` — Reference to ImageRepository
- `.spec.policy.semver.range` — Semver range filter (e.g., `">=1.0.0"`)
- `.spec.policy.alphabetical.order` — `asc` or `desc`
- `.spec.policy.numerical.order` — `asc` or `desc`
- `.spec.filterTags.pattern` — Regex to pre-filter tags
- `.spec.digestReflectionPolicy` — Whether to reflect digests

**Pattern:** Use `semver.range: ">=1.0.0"` for stable releases. Use `filterTags` to match naming conventions.

### ImageUpdateAutomation (`image.toolkit.fluxcd.io/v1`)

Automatically updates Git repositories with new image tags selected by ImagePolicy.

**Key fields:**
- `.spec.sourceRef` — Reference to GitRepository to update
- `.spec.interval` — Automation interval
- `.spec.git.checkout.ref` — Branch to checkout
- `.spec.git.commit.author` — Commit author (name, email)
- `.spec.git.commit.messageTemplate` — Commit message Go template
- `.spec.git.push.branch` — Branch to push changes to
- `.spec.update.path` — Path within the repo to scan for update markers
- `.spec.update.strategy` — `Setters` (default)

**Pattern:** Add markers in YAML files: `image: nginx:1.0.0 # {"$imagepolicy": "namespace:policy-name"}` or for chart versions: `version: 1.0.0 # {"$imagepolicy": "namespace:policy-name:tag"}`. The automation scans for these markers and updates the values.
**Gotcha:** The push branch can differ from checkout branch to create PRs instead of direct pushes.

## Common Validation Rules

- All resources must have `metadata.name` and `metadata.namespace`
- `interval` must be a valid Go duration (e.g., `5m`, `1h`, `30s`, `12h30m`)
- `sourceRef` must point to an existing source in the same namespace (unless cross-namespace refs are enabled)
- `dependsOn` references must exist and must not form circular dependencies
- Semver ranges must be valid (e.g., `>=1.0.0`, `1.x`, `~1.2.0`, `6.5.*`)
- Secret references must point to existing Secrets in the same namespace
